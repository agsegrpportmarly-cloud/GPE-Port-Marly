<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Espace adhérents – Port-Marly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles -->
  <link rel="stylesheet" href="../Style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .btn{padding:.6rem 1rem;border:1px solid #ccc;border-radius:.6rem;background:#043956;cursor:pointer;color:#fff}
    .btn.primary{border-color:#005c84;background:#005c84}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:2rem}
    .card{border:1px solid #e5e7eb;border-radius:16px;padding:18px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .muted{color:#6b7280}
    .hide{display:none}
    nav a{margin-right:1rem}
  </style>

  <!-- CSP méta (suffisant pour le self-host) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self';
          connect-src 'self' https://*.auth0.com https://*.cloudfront.net;
          img-src 'self' data: https:;
          style-src 'self' 'unsafe-inline' https:;
          font-src 'self' https: data:;
          base-uri 'self'
        ">

<!-- SDK local, à côté de la page -->
<script defer src="./vendor/auth0-spa-js.production.js"></script>

<!-- Intégration -->
<script defer src="../auth.js"></script>
</head>

<body>
  <header class="hero">
    
    <nav>
    <a href="/Index.html">Accueil</a>
    <a href="/Activites.html">Nos unités</a>
    <a href="/adherents/">Espace adhérents</a>
    <a href="/preinscriptions.html">Pré-Inscriptions</a>
    </nav>

  </header>

  <main class="container">
    <!-- Visiteur non connecté (par défaut) -->
    <section id="guest">
      <p class="muted"><b>Section réservée aux adhérents.</b> Merci de vous connecter.</p>
    </section>
 <!-- demande connexion -->
<form name="access-requests" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="name">
  <input type="email" name="email">
  <textarea name="message"></textarea>
  <input type="text" name="bot-field">
  <input type="hidden" name="form-name" value="access-requests">
</form>

<div id="access-modal" class="modal hidden" aria-hidden="true">
  <div class="modal-box">
    <h3>Demande d’accès</h3>
    <p>Indique tes coordonnées pour que l’équipe valide ton accès.</p>
    <form id="access-modal-form">
      <label>Nom et prénom
        <input type="text" name="name" required>
      </label>
      <label>Adresse e-mail
        <input type="email" name="email" required>
      </label>
      <label>Message (facultatif)
        <textarea name="message" rows="3" placeholder="Unité, rôle, etc."></textarea>
      </label>
      <div class="actions">
        <button type="button" id="access-cancel">Annuler</button>
        <button type="submit" id="access-send">Envoyer</button>
      </div>
    </form>
  </div>
</div>
    <!-- Connecté sans rôle -->
    <section id="no-role" class="hide">
      <p class="muted">Vous êtes connecté mais vous n’avez pas encore d’accès.</p>
      <button id="btn-request-access" class="cta">Demander l’accès</button>
    </section>
 <!-- demande connexion -->
<form name="access-requests" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="name">
  <input type="email" name="email">
  <textarea name="message"></textarea>
  <input type="text" name="bot-field">
  <input type="hidden" name="form-name" value="access-requests">
</form>

<div id="access-modal" class="modal hidden" aria-hidden="true">
  <div class="modal-box">
    <h3>Demande d’accès</h3>
    <p>Indique tes coordonnées pour que l’équipe valide ton accès.</p>
    <form id="access-modal-form">
      <label>Nom et prénom
        <input type="text" name="name" required>
      </label>
      <label>Adresse e-mail
        <input type="email" name="email" required>
      </label>
      <label>Message (facultatif)
        <textarea name="message" rows="3" placeholder="Unité, rôle, etc."></textarea>
      </label>
      <div class="actions">
        <button type="button" id="access-cancel">Annuler</button>
        <button type="submit" id="access-send">Envoyer</button>
      </div>
    </form>
  </div>
</div>
    <!-- Connecté (avec rendu selon rôles) -->
    <section id="app" class="hide">
      <p class="muted" id="welcome"></p>

      <fieldset id="fs-general" class="hide">
        <legend>Administratif</legend>
        <div class="grid">
          <a class="card" href="https://inscriptions-district-sgl.web.app/formulaire-inscription.html?type=jeune" target="_blank">
            <img src="../images/folder.png" alt="inscription" style="width:100%;border-radius:8px">
            <h3>Dossier d'inscription</h3>
          </a>
          <a class="card" href="/adherents/chefs.html">
            <img src="../images/camp.png" alt="camp" style="width:100%;border-radius:8px">
            <h3>Dossier d'inscriptions Camps</h3>
          </a>
          <a class="card" href="/adherents/dossiers.html">
            <img src="../images/calendar.png" alt="agenda" style="width:100%;border-radius:8px">
            <h3>Agenda</h3>
          </a>
        </div>
      </fieldset>

      <br>

      <fieldset id="fs-roles" class="hide">
        <legend>Les unités</legend>
        <div class="grid" id="role-cards">
          <a class="card" href="/PM/adherents/meute 1PM/index.html" data-roles="M1PM,admin">
            <h3>Meute 1ère <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/meute 3PM/index.html" data-roles="M3PM,admin">
            <h3>Meute 3ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/clairiere 2PM/index.html" data-roles="C2PM,admin">
            <h3>Clairière 2ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/clairiere 4PM/index.html" data-roles="C4PM,admin">
            <h3>Clairière 4ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/troupe 1 PM/index.html" data-roles="T1PM,admin">
            <h3>Troupe 1ère <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/troupe 3 PM/index.html" data-roles="T3PM,admin">
            <h3>Troupe 3ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/compagnie 2PM/index.html" data-roles="CI2PM,admin">
            <h3>Compagnie 2ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/compagnie 4PM/index.html" data-roles="CI4PM,admin">
            <h3>Compagnie 4ème <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/Feu/index.html" data-roles="FNDJ,admin">
            <h3>Feu<br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
          <a class="card" href="/PM/adherents/clan/index.html" data-roles="CSG,admin">
            <h3>Clan <br>Port Marly</h3>
            <p>Accéder à la page de l'unité.</p>
          </a>
        </div>
      </fieldset>
    </section>
  </main>
<script>
(function(){
  const btn = document.getElementById('btn-request-access');
  const modal = document.getElementById('access-modal');
  const form = document.getElementById('access-modal-form');
  const cancel = document.getElementById('access-cancel');

  // OPTIONNEL : auto-préremplir si tu as déjà l'utilisateur via Auth0/Firebase
  // Essaie de lire un utilisateur global si présent
  const guessUser = () => {
    // Essaies successives : adapte selon ton code
    try {
      if (window.currentUser && window.currentUser.email) return { name: window.currentUser.name || "", email: window.currentUser.email };
      if (window.authUser && window.authUser.email) return { name: window.authUser.name || "", email: window.authUser.email };
    } catch(e){}
    return { name: "", email: "" };
  };

  const openModal = () => {
    const { name, email } = guessUser();
    form.name.value = name || "";
    form.email.value = email || "";
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
    form.name.focus();
  };

  const closeModal = () => {
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
  };

  const encode = (data) =>
    Object.keys(data).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k])).join('&');

  const submitToNetlify = async (payload) => {
    // Envoi au endpoint statique pour Netlify Forms
    const res = await fetch('/', {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded' },
      body: encode({ 'form-name': 'access-requests', ...payload })
    });
    if (!res.ok) throw new Error('Netlify form post failed: ' + res.status);
    return true;
  };

  const mailtoFallback = (payload) => {
    const to = 'inscriptions.groupe.port-marly@gmail.com'; // ← mets ici l’adresse admin
    const subject = 'Demande d’accès – Espace adhérents';
    const body = `Bonjour,\n\nJe souhaite obtenir un accès à l’Espace adhérents.\n\nNom: ${payload.name || ''}\nEmail: ${payload.email || ''}\nMessage: ${payload.message || ''}\n\nMerci !`;
    window.location.href = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  };

  // Clic sur le bouton
  if (btn) {
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      openModal();
    });
  }

  // Fermer
  if (cancel) cancel.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  // Soumission modale => Netlify Forms + fallback mailto
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const submitBtn = document.getElementById('access-send');
    submitBtn.disabled = true; submitBtn.textContent = 'Envoi...';

    const payload = {
      name: form.name.value.trim(),
      email: form.email.value.trim(),
      message: form.message.value.trim()
    };

    try {
      await submitToNetlify(payload);
      submitBtn.textContent = 'Envoyé ✔';
      // petit feedback
      setTimeout(()=>{
        alert("Votre demande a bien été envoyée. Nous revenons vers vous rapidement.");
        closeModal();
        submitBtn.disabled = false; submitBtn.textContent = 'Envoyer';
        form.reset();
      }, 150);
    } catch(err){
      console.warn('Netlify Forms indisponible, fallback mailto.', err);
      mailtoFallback(payload);
      submitBtn.disabled = false; submitBtn.textContent = 'Envoyer';
      closeModal();
    }
  });
})();
</script>

  <footer>
    © AGSE – Groupes de Port-Marly <img src="../images/Logo_GS.png" alt="Logo AGSE" width="120" height="auto">
  </footer>
</body>
</html>